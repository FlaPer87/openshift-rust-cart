#!/bin/bash
#
# Adapted from https://github.com/kr/heroku-buildpack-go
#
# usage: bin/compile <build-dir> <cache-dir>

set -eo pipefail

source "${OPENSHIFT_RUST_DIR}/lib/util"

mkdir -p "$1" "$2"
build=$(cd "$1/" && pwd)
cache=$(cd "$2/" && pwd)
ver=${RUSTVERSION:-"1.0.0-beta.4"}
buildpack=$(dirname $(dirname $0))
rustup=https://static.rust-lang.org/rustup.sh
rust_cache=$cache/rust-$ver

# Python
venv=$cache/venv
mkdir -p $cache/pip
python=python2.7
PATH=$venv/bin:$PATH

if test -e $build/bin && ! test -d $build/bin
then
    echo >&2 " !     File bin exists and is not a directory."
    exit 1
fi

if ! test -f $build/.rustdir
then
    echo >&2 " !     A .rustdir is required"
    exit 1
fi

if test -d $rust_cache/bin/rustc
then
    echo "-----> Using Rust $ver"
else
    mkdir -p $rust_cache
    echo    "       First download, may take several minutes"
    echo -n "-----> Installing Rust $ver..."
    curl -sOf $rustup
    HOME=$cache sh rustup.sh --prefix=$rust_cache --channel=beta --yes --disable-sudo
    rm rustup.sh
    echo " done"
fi

RUSTROOT=$rust_cache
export RUSTROOT

RUSTPATH=$build/.openshift/r
export RUSTPATH

export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$RUSTROOT/lib

if test -f $build/.rustpath
then
    CUSTOM_RUSTPATH=$OPENSHIFT_HOMEDIR$(get_rustpath $build/.rustpath)
    export CUSTOM_RUSTPATH
fi

name=$(get_rustdir $build/.rustpath)
p=${CUSTOM_RUSTPATH:-$RUSTPATH}/src/$name
b=${CUSTOM_RUSTPATH:-$RUSTPATH}/bin

echo $build
echo $p
echo $b

mkdir -p $p
cp -a $build/* $p

unset GIT_DIR # unset git dir or it will mess with goinstall
echo "-----> Running: cargo build"
cd $p

if test -f $build/.rustpath
then
    RUSTPATH=$CUSTOM_RUSTPATH:$RUSTPATH
    export RUSTPATH
fi
cargo build

mkdir -p $build/bin
mv $b/* $build/bin

mkdir -p $build/.profile.d
echo 'export PATH=$PATH' > $build/.profile.d/go.sh

rm -rf $build/.openshift/g # this removes the constructed $RUSTPATH

echo $RUSTROOT > $OPENSHIFT_RUST_DIR/env/RUSTROOT
echo $RUSTPATH > $OPENSHIFT_RUST_DIR/env/RUSTPATH
echo "$HOME/bin:$RUSTROOT/bin" > $OPENSHIFT_RUST_DIR/env/OPENSHIFT_RUST_PATH_ELEMENT
echo "$LD_LIBRARY_PATH:$RUSTROOT/lib" > $OPENSHIFT_RUST_DIR/env/LD_LIBRARY_PATH

echo $OPENSHIFT_RUST_IP > $OPENSHIFT_RUST_DIR/env/HOST
echo $OPENSHIFT_RUST_PORT > $OPENSHIFT_RUST_DIR/env/PORT
